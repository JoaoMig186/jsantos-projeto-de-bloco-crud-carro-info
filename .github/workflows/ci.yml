name: CI - Continuous Integration

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write
  issues: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execu√ß√£o do Gradle Wrapper
        run: |
          echo "::group::Configura√ß√£o do Gradle Wrapper"
          chmod +x gradlew
          echo "::notice::Gradle Wrapper configurado"
          echo "::endgroup::"

      - name: Build do projeto
        run: |
          echo "::group::Build do projeto"
          ./gradlew clean build --no-daemon
          echo "::notice::Build finalizado com sucesso"
          echo "::endgroup::"

      - name: Executar testes com cobertura
        run: |
          echo "::group::Testes automatizados"
          ./gradlew test jacocoTestReport --no-daemon
          echo "::notice::Testes conclu√≠dos e cobertura gerada"
          echo "::endgroup::"

      - name: Resumo do Build e Testes
        run: |
          echo "## üîß Build & Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Build: **conclu√≠do com sucesso**" >> $GITHUB_STEP_SUMMARY
          echo "- Testes: **executados**" >> $GITHUB_STEP_SUMMARY
          echo "- Cobertura Jacoco: dispon√≠vel nos artefatos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Publicar resultados dos testes
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build/reports/tests/test

      - name: Publicar relat√≥rio de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/jacoco/test/html

  code-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build para CodeQL
        run: |
          echo "::group::Build para an√°lise est√°tica"
          ./gradlew clean build --no-daemon
          echo "::endgroup::"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'java'

      - name: Run CodeQL autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Executar an√°lise est√°tica com SpotBugs
        run: |
          echo "::group::SpotBugs"
          ./gradlew spotbugsMain spotbugsTest --no-daemon
          echo "::notice::Relat√≥rio SpotBugs gerado"
          echo "::endgroup::"

      - name: Resumo de An√°lise Est√°tica
        run: |
          echo "## üõ°Ô∏è Code Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL: **execu√ß√£o completa**" >> $GITHUB_STEP_SUMMARY
          echo "- SpotBugs: relat√≥rios anexados como artefatos" >> $GITHUB_STEP_SUMMARY

      - name: Publicar relat√≥rios SpotBugs
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report
          path: build/reports/spotbugs

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Iniciar aplica√ß√£o (Javalin)
        run: |
          echo "::group::Inicializa√ß√£o da aplica√ß√£o"
          ./gradlew run &
          for i in {1..30}; do
            if curl -f http://localhost:7000/ > /dev/null 2>&1; then
              echo "::notice::Aplica√ß√£o iniciada!"
              break
            fi
            sleep 1
          done
          echo "::endgroup::"

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        continue-on-error: true
        with:
          target: "http://localhost:7000"
          cmd_options: "-a"
          upload_artifact: false

      - name: Resumo do ZAP
        run: |
          echo "## üîí Seguran√ßa" >> $GITHUB_STEP_SUMMARY
          echo "- ZAP Baseline Scan executado" >> $GITHUB_STEP_SUMMARY
          echo "- Relat√≥rios anexados como artefatos" >> $GITHUB_STEP_SUMMARY

      - name: Upload ZAP Scan Report (JSON)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-json
          path: report_json.json
          if-no-files-found: ignore

  selenium-tests:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Instalar Chrome/Chromium
        run: |
          echo "::group::Instala√ß√£o do Chromium"
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
          echo "::endgroup::"

      - name: Iniciar aplica√ß√£o em background
        run: |
          ./gradlew run &
          for i in {1..30}; do
            if curl -f http://localhost:7000/ > /dev/null 2>&1; then
              break
            fi
            sleep 1
          done

      - name: Executar testes Selenium
        run: |
          echo "::group::Selenium"
          ./gradlew uiTest --no-daemon
          echo "::notice::Testes de interface executados"
          echo "::endgroup::"

      - name: Resumo do Selenium
        run: |
          echo "## üåê Selenium UI Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Testes UI executados" >> $GITHUB_STEP_SUMMARY
          echo "- Relat√≥rio anexado como artefato" >> $GITHUB_STEP_SUMMARY

      - name: Publicar relat√≥rios Selenium
        uses: actions/upload-artifact@v4
        with:
          name: selenium-test-report
          path: build/reports/tests/test
