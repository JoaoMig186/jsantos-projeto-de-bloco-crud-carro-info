name: CI - Continuous Integration

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write
  issues: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execução do Gradle Wrapper
        run: chmod +x gradlew

      - name: Build do projeto
        run: ./gradlew clean build --no-daemon

      - name: Executar testes com cobertura
        run: ./gradlew test jacocoTestReport --no-daemon

      - name: Publicar resultados dos testes
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build/reports/tests/test

      - name: Publicar relatório de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/jacoco/test/html

  code-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execução do Gradle Wrapper
        run: chmod +x gradlew

      - name: Build para CodeQL
        run: ./gradlew clean build --no-daemon

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'java'

      - name: Run CodeQL autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Executar análise estática com SpotBugs
        run: ./gradlew spotbugsMain spotbugsTest --no-daemon

      - name: Publicar relatórios SpotBugs
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report
          path: build/reports/spotbugs

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execução do Gradle Wrapper
        run: chmod +x gradlew

      - name: Iniciar aplicação (Javalin)
        run: |
          ./gradlew run &
          echo "Aguardando aplicação iniciar..."
          sleep 10

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: "http://localhost:7000"
          cmd_options: "-a"

      - name: Upload ZAP Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan
          path: report-zap/

      - name: Finalizar aplicação
        run: |
          echo "Encerrando aplicação..."
          pkill -f "GradleDaemon" || true

  selenium-tests:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execução do Gradle Wrapper
        run: chmod +x gradlew

      - name: Instalar Chrome/Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
          # Criar symlink se necessário
          sudo ln -sf /usr/bin/chromium-browser /usr/bin/google-chrome || true

      - name: Iniciar aplicação em background
        run: |
          ./gradlew run &
          APP_PID=$!
          echo "Aguardando aplicação iniciar..."
          for i in {1..30}; do
            if curl -f http://localhost:7000/ > /dev/null 2>&1; then
              echo "Aplicação iniciada com sucesso!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Erro: Aplicação não iniciou a tempo"
              exit 1
            fi
            sleep 1
          done

      - name: Executar testes Selenium
        run: ./gradlew uiTest --no-daemon
        env:
          GITHUB_ACTIONS: true
          CHROME_BIN: /usr/bin/chromium-browser
          CHROMEDRIVER_PATH: /usr/bin/chromedriver

      - name: Publicar relatórios de testes Selenium
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: selenium-test-report
          path: build/reports/tests/test

      - name: Finalizar aplicação
        if: always()
        run: |
          echo "Encerrando aplicação..."
          pkill -f "GradleDaemon" || true
          pkill -f "java.*Main" || true

