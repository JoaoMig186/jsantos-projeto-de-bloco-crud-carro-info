name: Deploy - Test/Staging

on:
  push:
    branches: [ test, staging ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Pular testes antes do deploy?'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-test
  cancel-in-progress: false

jobs:
  pre-deploy-checks:
    name: VerificaÃ§Ãµes PrÃ©-Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execuÃ§Ã£o do Gradle Wrapper
        run: chmod +x gradlew

      - name: Executar testes
        if: github.event.inputs.skip_tests != 'true'
        run: ./gradlew test --no-daemon

      - name: Verificar cobertura mÃ­nima
        if: github.event.inputs.skip_tests != 'true'
        run: |
          # Verificar se a cobertura atinge o mÃ­nimo (exemplo: 70%)
          echo "âœ… Testes passaram - prosseguindo com deploy"

  deploy-test:
    name: Deploy para Ambiente TEST
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    environment:
      name: test

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execuÃ§Ã£o do Gradle Wrapper
        run: chmod +x gradlew

      - name: Build JAR
        run: ./gradlew clean build --no-daemon

      - name: Verificar JAR gerado
        run: |
          JAR_FILE=$(ls build/libs/*.jar | grep -v "sources\|javadoc" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ Erro: JAR nÃ£o encontrado"
            exit 1
          fi
          echo "âœ… JAR: $JAR_FILE ($(du -h "$JAR_FILE" | cut -f1))"

      - name: Publicar JAR para TEST
        uses: actions/upload-artifact@v4
        with:
          name: app-jar-test
          path: build/libs/*.jar
          retention-days: 14

      - name: Copiar JAR para servidor TEST
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.TEST_SSH_HOST }}
          username: ${{ secrets.TEST_SSH_USER }}
          key: ${{ secrets.TEST_SSH_KEY }}
          port: ${{ secrets.TEST_SSH_PORT || 22 }}
          source: "build/libs/*.jar"
          target: "${{ secrets.TEST_DEPLOY_PATH || '/var/www/javalin-test' }}/app.jar"
          strip_components: 0
          overwrite: true

      - name: Executar deploy no servidor TEST
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.TEST_SSH_HOST }}
          username: ${{ secrets.TEST_SSH_USER }}
          key: ${{ secrets.TEST_SSH_KEY }}
          port: ${{ secrets.TEST_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.TEST_DEPLOY_PATH || '/var/www/javalin-test' }}
            echo "ðŸ”„ Iniciando deploy em TEST..."
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: ${{ github.sha }}"
            
            # Backup do JAR anterior
            if [ -f app.jar ]; then
              cp app.jar app.jar.backup.$(date +%Y%m%d_%H%M%S)
              echo "âœ… Backup criado"
            fi
            
            # Parar aplicaÃ§Ã£o anterior
            pkill -f "java.*app.jar" || true
            sleep 2
            
            # Iniciar nova aplicaÃ§Ã£o
            nohup java -jar app.jar > app.log 2>&1 &
            sleep 3
            
            # Verificar se iniciou
            if pgrep -f "java.*app.jar" > /dev/null; then
              echo "âœ… AplicaÃ§Ã£o iniciada com sucesso"
            else
              echo "âŒ Erro ao iniciar aplicaÃ§Ã£o"
              exit 1
            fi

      - name: Executar testes de smoke no ambiente TEST
        run: |
          sleep 5
          if curl -f ${{ secrets.TEST_URL || 'http://test.example.com' }}/ > /dev/null 2>&1; then
            echo "âœ… Smoke test passou"
          else
            echo "âŒ Smoke test falhou"
            exit 1
          fi

      - name: Notificar deploy concluÃ­do
        if: success()
        run: |
          echo "## âœ… Deploy TEST ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ambiente**: Test/Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ secrets.TEST_URL || 'N/A' }}" >> $GITHUB_STEP_SUMMARY

