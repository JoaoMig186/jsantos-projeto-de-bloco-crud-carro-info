name: Deploy - Production

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o para deploy (ex: 1.0.0)'
        required: true
        type: string

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  build:
    name: Build para ProduÃ§Ã£o
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execuÃ§Ã£o do Gradle Wrapper
        run: chmod +x gradlew

      - name: Build JAR
        run: ./gradlew clean build --no-daemon

      - name: Criar tag (somente em workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release version $VERSION"
          git push origin "v$VERSION" || echo "âš  Tag jÃ¡ existe ou sem permissÃ£o"

      - name: Publicar JAR como artefato
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar

  deploy:
    name: Deploy no Servidor
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Baixar JAR da etapa anterior
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./deploy

      - name: Copiar JAR para o servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          source: "./deploy/*.jar"
          target: "${{ secrets.PROD_DEPLOY_PATH }}/app.jar"
          overwrite: true

      - name: Reiniciar aplicaÃ§Ã£o no servidor
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.PROD_DEPLOY_PATH }}

            echo "ðŸ›‘ Parando aplicaÃ§Ã£o atual..."
            pkill -f "java.*app.jar" || true
            sleep 2

            echo "â–¶ï¸ Iniciando nova versÃ£o..."
            nohup java -jar app.jar > app.log 2>&1 &

            sleep 5
            if pgrep -f "java.*app.jar" >/dev/null; then
              echo "âœ… AplicaÃ§Ã£o iniciada com sucesso!"
            else
              echo "âŒ Falha ao iniciar a aplicaÃ§Ã£o"
              exit 1
            fi

      - name: VerificaÃ§Ã£o rÃ¡pida
        run: |
          echo "ðŸ” Verificando aplicaÃ§Ã£o em produÃ§Ã£o..."
          if curl -f ${{ secrets.PROD_URL }} >/dev/null 2>&1; then
            echo "âœ… AplicaÃ§Ã£o responde normalmente"
          else
            echo "âš ï¸ AplicaÃ§Ã£o pode nÃ£o estar respondendo ainda"
          fi

      - name: Gerar resumo do deploy
        run: |
          echo "## ðŸš€ Deploy PRODUÃ‡ÃƒO ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL ProduÃ§Ã£o**: ${{ secrets.PROD_URL }}" >> $GITHUB_STEP_SUMMARY
