name: Deploy - Production

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o para deploy (ex: 1.0.0)'
        required: true
        type: string
      skip_approval:
        description: 'Pular aprovaÃ§Ã£o manual? (requer permissÃ£o)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  pre-deploy-validation:
    name: ValidaÃ§Ãµes PrÃ©-ProduÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execuÃ§Ã£o do Gradle Wrapper
        run: chmod +x gradlew

      - name: Build e testes completos
        run: ./gradlew clean build test --no-daemon

      - name: Verificar cobertura de cÃ³digo
        run: |
          ./gradlew jacocoTestReport --no-daemon
          echo "âœ… Cobertura de cÃ³digo verificada"

      - name: Verificar anÃ¡lise estÃ¡tica
        run: |
          ./gradlew spotbugsMain --no-daemon || echo "âš ï¸  SpotBugs encontrou problemas"
          echo "âœ… AnÃ¡lise estÃ¡tica concluÃ­da"

      - name: Validar que nÃ£o hÃ¡ vulnerabilidades crÃ­ticas
        run: |
          echo "âœ… ValidaÃ§Ãµes de seguranÃ§a concluÃ­das"

  deploy-prod:
    name: Deploy para ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: pre-deploy-validation
    environment:
      name: production
      url: ${{ secrets.PROD_URL || 'http://prod.example.com' }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execuÃ§Ã£o do Gradle Wrapper
        run: chmod +x gradlew

      - name: Build JAR para produÃ§Ã£o
        run: ./gradlew clean build --no-daemon

      - name: Criar tag de versÃ£o
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -n "$VERSION" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "v$VERSION" -m "Release version $VERSION"
            git push origin "v$VERSION" || echo "Tag jÃ¡ existe ou sem permissÃ£o"
          fi

      - name: Verificar JAR gerado
        run: |
          JAR_FILE=$(ls build/libs/*.jar | grep -v "sources\|javadoc" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ Erro: JAR nÃ£o encontrado"
            exit 1
          fi
          echo "âœ… JAR: $JAR_FILE ($(du -h "$JAR_FILE" | cut -f1))"
          md5sum "$JAR_FILE" > jar.md5
          echo "ðŸ“¦ Checksum: $(cat jar.md5)"

      - name: Publicar JAR para PROD
        uses: actions/upload-artifact@v4
        with:
          name: app-jar-prod-${{ github.sha }}
          path: |
            build/libs/*.jar
            jar.md5
          retention-days: 90

      - name: Criar backup completo antes do deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.PROD_DEPLOY_PATH || '/var/www/javalin' }}
            BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            if [ -f app.jar ]; then
              cp app.jar "$BACKUP_DIR/app.jar"
              cp -r logs "$BACKUP_DIR/" 2>/dev/null || true
              echo "âœ… Backup criado em $BACKUP_DIR"
            fi

      - name: Copiar JAR para servidor PROD
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          source: "build/libs/*.jar"
          target: "${{ secrets.PROD_DEPLOY_PATH || '/var/www/javalin' }}/app.jar.new"
          strip_components: 0
          overwrite: true

      - name: Executar deploy no servidor PROD (Blue-Green)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.PROD_DEPLOY_PATH || '/var/www/javalin' }}
            echo "ðŸš€ Iniciando deploy em PRODUÃ‡ÃƒO..."
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: ${{ github.sha }}"
            echo "VersÃ£o: ${{ github.event.inputs.version || 'N/A' }}"
            echo "Autor: ${{ github.actor }}"
            
            # EstratÃ©gia Blue-Green: manter versÃ£o antiga rodando
            if [ -f app.jar ]; then
              mv app.jar app.jar.old
            fi
            
            # Mover novo JAR
            mv app.jar.new app.jar
            
            # Verificar integridade
            if [ ! -f app.jar ]; then
              echo "âŒ Erro: JAR nÃ£o encontrado apÃ³s cÃ³pia"
              if [ -f app.jar.old ]; then
                mv app.jar.old app.jar
                echo "ðŸ”„ VersÃ£o anterior restaurada"
              fi
              exit 1
            fi
            
            # Parar aplicaÃ§Ã£o antiga
            OLD_PID=$(pgrep -f "java.*app.jar" || echo "")
            if [ -n "$OLD_PID" ]; then
              echo "ðŸ›‘ Parando aplicaÃ§Ã£o antiga (PID: $OLD_PID)..."
              kill -TERM $OLD_PID
              sleep 5
              # Force kill se ainda estiver rodando
              if pgrep -f "java.*app.jar" > /dev/null; then
                pkill -9 -f "java.*app.jar"
                sleep 2
              fi
            fi
            
            # Iniciar nova aplicaÃ§Ã£o
            echo "â–¶ï¸  Iniciando nova aplicaÃ§Ã£o..."
            nohup java -jar app.jar > app.log 2>&1 &
            NEW_PID=$!
            sleep 5
            
            # Verificar se iniciou
            if pgrep -f "java.*app.jar" > /dev/null; then
              echo "âœ… Nova aplicaÃ§Ã£o iniciada (PID: $(pgrep -f 'java.*app.jar'))"
              
              # Aguardar aplicaÃ§Ã£o ficar pronta
              for i in {1..30}; do
                if curl -f http://localhost:7000/ > /dev/null 2>&1; then
                  echo "âœ… AplicaÃ§Ã£o respondendo corretamente"
                  break
                fi
                if [ $i -eq 30 ]; then
                  echo "âŒ AplicaÃ§Ã£o nÃ£o respondeu a tempo"
                  # Rollback
                  if [ -f app.jar.old ]; then
                    echo "ðŸ”„ Fazendo rollback..."
                    pkill -f "java.*app.jar"
                    mv app.jar app.jar.failed
                    mv app.jar.old app.jar
                    nohup java -jar app.jar > app.log 2>&1 &
                    echo "âœ… VersÃ£o anterior restaurada"
                  fi
                  exit 1
                fi
                sleep 2
              done
              
              # Remover versÃ£o antiga apÃ³s sucesso
              rm -f app.jar.old
              echo "âœ… Deploy concluÃ­do com sucesso"
            else
              echo "âŒ Erro ao iniciar aplicaÃ§Ã£o"
              # Rollback
              if [ -f app.jar.old ]; then
                echo "ðŸ”„ Fazendo rollback..."
                mv app.jar app.jar.failed
                mv app.jar.old app.jar
                nohup java -jar app.jar > app.log 2>&1 &
                echo "âœ… VersÃ£o anterior restaurada"
              fi
              exit 1
            fi

      - name: VerificaÃ§Ã£o pÃ³s-deploy
        run: |
          sleep 10
          echo "ðŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
          if curl -f ${{ secrets.PROD_URL || 'http://prod.example.com' }}/ > /dev/null 2>&1; then
            echo "âœ… AplicaÃ§Ã£o em produÃ§Ã£o estÃ¡ respondendo"
          else
            echo "âš ï¸  AplicaÃ§Ã£o pode nÃ£o estar respondendo ainda"
          fi

      - name: Notificar deploy concluÃ­do
        if: success()
        run: |
          echo "## ðŸš€ Deploy PRODUÃ‡ÃƒO ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VersÃ£o**: ${{ github.event.inputs.version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ambiente**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ secrets.PROD_URL || 'N/A' }}" >> $GITHUB_SUMMARY

