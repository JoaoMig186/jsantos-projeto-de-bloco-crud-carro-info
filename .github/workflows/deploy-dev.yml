name: Deploy - Development

on:
  push:
    branches: [ develop, dev ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'ForÃ§ar deploy mesmo com falhas?'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-dev
  cancel-in-progress: false

jobs:
  deploy-dev:
    name: Deploy para Ambiente DEV
    runs-on: ubuntu-latest
    environment:
      name: development

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Permitir execuÃ§Ã£o do Gradle Wrapper
        run: chmod +x gradlew

      - name: Build JAR
        run: ./gradlew clean build --no-daemon

      - name: Verificar JAR gerado
        run: |
          JAR_FILE=$(ls build/libs/*.jar | grep -v "sources\|javadoc" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ Erro: JAR nÃ£o encontrado"
            exit 1
          fi
          echo "âœ… JAR: $JAR_FILE ($(du -h "$JAR_FILE" | cut -f1))"

      - name: Publicar JAR para DEV
        uses: actions/upload-artifact@v4
        with:
          name: app-jar-dev
          path: build/libs/*.jar
          retention-days: 7

      - name: Copiar JAR para servidor DEV
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT || 22 }}
          source: "build/libs/*.jar"
          target: "${{ secrets.DEV_DEPLOY_PATH || '/var/www/javalin-dev' }}/app.jar"
          strip_components: 0
          overwrite: true

      - name: Executar deploy no servidor DEV
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEV_DEPLOY_PATH || '/var/www/javalin-dev' }}
            echo "ðŸ”„ Iniciando deploy em DEV..."
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: ${{ github.sha }}"
            echo "Autor: ${{ github.actor }}"
            
            # Backup do JAR anterior
            if [ -f app.jar ]; then
              cp app.jar app.jar.backup.$(date +%Y%m%d_%H%M%S)
              echo "âœ… Backup criado"
            fi
            
            # Parar aplicaÃ§Ã£o anterior
            pkill -f "java.*app.jar" || true
            sleep 2
            
            # Iniciar nova aplicaÃ§Ã£o
            nohup java -jar app.jar > app.log 2>&1 &
            sleep 3
            
            # Verificar se iniciou
            if pgrep -f "java.*app.jar" > /dev/null; then
              echo "âœ… AplicaÃ§Ã£o iniciada com sucesso"
            else
              echo "âŒ Erro ao iniciar aplicaÃ§Ã£o"
              if [ -f app.jar.backup.* ]; then
                echo "ðŸ”„ Restaurando backup..."
                RESTORE_FILE=$(ls -t app.jar.backup.* | head -n 1)
                mv "$RESTORE_FILE" app.jar
                nohup java -jar app.jar > app.log 2>&1 &
              fi
              exit 1
            fi

      - name: Verificar saÃºde da aplicaÃ§Ã£o
        run: |
          sleep 5
          if curl -f ${{ secrets.DEV_URL || 'http://dev.example.com' }}/ > /dev/null 2>&1; then
            echo "âœ… AplicaÃ§Ã£o respondendo corretamente"
          else
            echo "âš ï¸  AplicaÃ§Ã£o pode nÃ£o estar respondendo ainda"
          fi

      - name: Notificar deploy concluÃ­do
        if: success()
        run: |
          echo "## âœ… Deploy DEV ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ambiente**: Development" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ secrets.DEV_URL || 'N/A' }}" >> $GITHUB_STEP_SUMMARY

